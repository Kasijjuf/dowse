<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Mosquitto Websockets</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.7.1/d3.js"></script>
  <script type="text/javascript">
// configuration
host = '192.168.0.254';    // hostname or IP address of the dowse box
port = 1888;
topic = 'dns-query-channel'; // topic to subscribe to
useTLS = false;
username = null;
password = null;
cleansession = true;
// end of conf

var mqtt;
var reconnectTimeout = 20000;

function add_calling( ip, query, calling ){
    if (ip in calling ) {        
        var history=calling[ip];
        if (query in history) {
            history[query]++;
        } else {
            history[query] = 1 ;
        }        
        calling[ip] = history;        
    } else {
        var c={ };
        c[query]=1;
        calling[ip]=c;
    }
}

function MQTTconnect() {
    var source=[];
    var destination=[];
    
    /*--- Questo sara' una strutta key - value dove i value è una mappa di tipo : {query , counter} */
    var calling={};
    
    
    mqtt = new Paho.MQTT.Client(
        host,
        port,
        "web_" + parseInt(Math.random() * 100,
                          10));

    var options = {
        timeout: 3,
        useSSL: useTLS,
        cleanSession: cleansession,
        onSuccess: onConnect,
        onFailure: function (message) {
            $('#status').val("Connection failed: " + message.errorMessage + "Retrying");
            setTimeout(MQTTconnect, reconnectTimeout);
        }
    };

    mqtt.onConnectionLost = onConnectionLost;
    mqtt.onMessageArrived = onMessageArrived;

    if (username != null) {
        options.userName = username;
        options.password = password;
    }
    console.log("Host="+ host + ", port=" + port + " TLS = " + useTLS +
        " username=" + username + " password=" + password);
    mqtt.connect(options);
}

function onConnect() {
    $('#status').val('Connected to ' + host + ':' + port);
    // Connection succeeded; subscribe to our topic
    mqtt.subscribe(topic, {qos: 0});
    $('#topic').val(topic);
}

function onConnectionLost(response) {
    setTimeout(MQTTconnect, reconnectTimeout);
    $('#status').val("connection lost: " + responseObject.errorMessage + ". Reconnecting");

};


//------------------
var calling_vect=
    [ { ip: '192.168.0.1' ,
        total : 9,
        query_history : [
            { domain : 'google.it', called : 3 } ,
            { domain : 'corriere.it' , called : 2 } ,
            { domain : 'xkcd.org',called : 2 },                
            { domain : 'facebook.com', called : 2}
          ]
      },
      { ip: '192.168.0.2' ,
        total : 6,
        query_history : [
            { domain : 'facebook.com', called : 1 } ,
            { domain : 'repubblica.it' , called : 2 } ,
            { domain : 'google.it',called : 3 }                
          ]
      }
     ];
     
     
function draw_arc(x0,y0,teta1,teta2,rho_in,rho_out) {
    /* Ritorna la stringa per disegnare :
     * 
     *  - un arco centrato in x,y e che parte da teta1 e arriva a teta2
     *  - il cui interno e' rho_in e l'esterno e rho_out
     *  
     * */    
    
    var str="";

    var x1=x0+rho_in*Math.sin(teta1);
    var y1=y0+rho_in*Math.cos(teta1);

    var x2=x0+rho_in*Math.sin(teta2);
    var y2=y0+rho_in*Math.cos(teta2);

    var x3=x0+rho_out * Math.sin(teta2);
    var y3 = y0 + rho_out * Math.cos(teta2);
    
    var x4 = x0 + rho_out * Math.sin(teta1);
    var y4 = y0 + rho_out * Math.cos(teta1);

    str += "M" + x1 + " " + y1 + " ";

    var internal;
    if (teta2 - teta1 < 180) {
        internal = 0;
    } else {
        internal = 1;
    }

    var clock_wise = 0;
    str += "A " + rho_in + " " + rho_in + " 0 " + internal + " " + clock_wise + " " + " " + x2 + " " + y2 + " ";
    
    str += "L "+ x3 +" "+y3+" ";
    
    clock_wise=(clock_wise+1)%2;
//    internal=(internal+1)%2;
    
    str += "A " + rho_out + " " + rho_out + " 0 " + internal + " " + clock_wise + " " + " " + x4 + " " + y4 + " ";
    
    str += "L "+ x1 +" "+y1+" ";
return str;
}

function print_called(calling_vect){   
     /* Prima leggiamo tutte le query e creiamo un vettore 
      *  che è l'equivalente di:
      *     select domain,sum(calling) group by domain;
      *  */
     var map_q={};
     
     
     /**/
     var calling_total=0;
     for (var i=0;i<calling_vect.length;i++) {
        var qh=calling_vect[i].query_history;
        for (var k=0;k<qh.length;k++) {
              var key= (qh[k].domain).replace(".","_");
              if ( [key] in map_q ) {
                 map_q[key] += qh[k].called ;
             } else {
                 map_q[key] = qh[k].called ;                
             }
             calling_total+=qh[k].called;
        }
     }
     
      
     var call_grouped=[];
     for (var f in map_q ) {
         call_grouped.push({ domain: f , called: map_q[f]});
     }
 
     /* In map_q ho tutte i domini con i relativi conteggi */
     /*  calling_total contiene la somma */
     var teta_unit= 2.*Math.PI / (calling_total+call_grouped.length) ;
     
     var width=700;
     var height=width;
    
     var origin=0;
     var svg=d3.select(".ringcontainer").append("svg")
            .attr("width",width)
            .attr("height",height);
            
        svg.append("g")
            .selectAll("path")
                .data(call_grouped)
                .enter()
                .append("path")
                .attr('d', function(d,i) { 
                    var str="";
        
                    str=draw_arc(width/2,height/2,  (origin)*teta_unit , (origin+ d.called)*teta_unit, 0.9*width/2.,width/2);
                    
                    origin+=(1+d.called);
                    return str;
                })
                .attr('stroke', "black")
                .attr("fill",function(d,i){
                    console.log("filling");
                    return ( "rgb("+Math.floor(Math.random()*255)+","
                                 +Math.floor(Math.random()*255)+","
                                 +Math.floor(Math.random()*255)+""
                            + ")");
                })
                .style("stroke-width", "2")
                .style("fill-opacity", "0.5")
          ;
        
      svg.append("g")
            .selectAll("circle")
                .data(calling_vect)
                .enter()
                .append("circle")
                .style("fill", "steelblue")
                .attr('cx', function() { return Math.random() * width;})
                .attr('cy', function() { return Math.random() * height;})
                .attr("r",function(d,i){return d.total });
    
}
     

function onMessageArrived(message) {

    var topic = message.destinationName;
    var payload = message.payloadString;

    var field=payload.splot(",");
    $('#ws').prepend('<li>' + topic + ' = ' + payload + '</li>');
    
    var ip=field[1];
    var dest=field[4];
    console.log("ip:"+ip);
  
        // TODO la struttura sara' doppia 
//    calling(ip, dest, calling);
//    print_calling(calling_vect);
};

     
$(document).ready(function() {
    /* TODO decommentare per agganciare */
  //  MQTTconnect();
   print_called(calling_vect);

  //print_calling(calling_vect);
});


  </script>
  
  <!-- -->
  
    </head>
    <body>
        <div>Dowse example </div>
         <div class="row">
        Subscribed to <input type='text' id='topic' disabled />
        Status: <input type='text' id='status' size="80" disabled />
    </div>

    <div class="row">
        <!-- 
      <ul id='ws' style="font-family: 'Courier New', Courier, monospace;"></ul>
        -->
        <div class="ringcontainer"></div>
    </div>
    </body>
</html>
